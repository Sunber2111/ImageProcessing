const cv = require('./opencv')
const { createCanvas, Image , loadImage, createImageData } = require('canvas')

const common = async (url,next=null) => {

    image = await loadImage(url)
    const src = cv.imread(image)
    let dst = new cv.Mat(src.size(), 0)
    let canvas = createCanvas(image.width, image.height)
    if(next)
    {    
        next(src,dst)
    }
    else
    {
        // default return grayscale
        cv.imshow(canvas, src)
        src.delete()
        dst.delete()
        return canvas.toDataURL()
    }
    cv.imshow(canvas, dst)
    src.delete()
    dst.delete()
    return canvas.toDataURL()
    
}

const color2Gray = async url => {   
    try {

        let func = (src,dst)=>{
            for (let row = 0; row < src.rows; row++) {
                for (let col = 0; col < src.cols; col++) {
        
                    dst.ucharPtr(row, col)[0] = 
                        Math.round((src.ucharPtr(row, col)[0] + src.ucharPtr(row, col)[1] + src.ucharPtr(row, col)[2]) / 3)
        
                }
            }   
        } 
    
        return await common(url,func)

    } catch (error) {
        throw error
    }
}

const convertToBase64 = async url =>{
    try {

        return await common(url)

    } catch (error) {
        throw error
    }
}

module.exports = {
    color2Gray,
    convertToBase64
}